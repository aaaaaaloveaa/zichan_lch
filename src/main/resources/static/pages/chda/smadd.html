<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<!--<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">-->
<link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
<link rel="stylesheet" href="../../layuiadmin/eleTree/eleTree.css" media="all">
	<style>
		.eleTree{
			width: 350px;
			height: 500px;
			border: 1px solid #ccc;
			overflow: hidden;
			display: inline-block;
		}
		.ele5{
			height: auto;
			width: 98%;
			display: none;
			position: absolute;
			top:100%;
			background-color: #fff;
			z-index: 100;
		}
	</style>
</head>
<body>
<div class="layui-fluid">
<div class="layui-card">
<!--	<div class="layui-card-header" align="center" ><h1>存货档案管理</h1></div>-->
	<div class="layui-card-body">
		<form  class="layui-form layui-form-pane" onsubmit="return false" id="form">
			<input type="hidden" id="id" name="id">
			<input type="hidden" id="ppath" name="ppath">
			<div class='layui-form-item'>
				<div class='layui-inline'>
					<label class='layui-form-label'>存货分类</label>
					<div class='layui-input-block'>
						<!--<select placeholder='存货分类' type='text' name='pid' id='pid' lay-verify="required"
                                lay-verType="tips">
                        </select>-->
						<input class="layui-input" type="text" id="invcid" name="invcid" data-id=""  placeholder="请选择分类" readonly="" autocomplete="off">
						<div class="eleTree ele5" lay-filter="eleTree"></div>
					</div>
				</div>

<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
					<label class='layui-form-label'>编码</label>
					<div class='layui-input-block'>
						<input class='layui-input' placeholder='编码' type='text' name='invcode' id='invcode'  lay-verType="tips">
					</div>
				</div>

			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>存货名称</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='存货名称' type='text' name='invname' id='invname' lay-verify="required" lay-verType="tips">
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>规格型号</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='规格型号' type='text' name='invstd' id='invstd' lay-verType="tips">
				</div>
				</div>
			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>单位</label>
				<div class='layui-input-block'>
					<select id="unit1" name="unit1"></select>
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>零售价</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='零售价' type='text' name='iprice' id='iprice'   lay-verType="tips">
				</div>
				</div>
			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>批发价</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='批发价' type='text' name='viprice' id='viprice'   lay-verType="tips">
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>配送价</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='配送价' type='text' name='icost' id='icost'  lay-verType="tips">
				</div>
				</div>
			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>长度</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='单位长度' type='text' name='iweight' id='iweight'  lay-verType="tips">
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>米重</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='米重' type='text' name='c01' id='c01'  lay-verType="tips">
				</div>
				</div>
			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>件重</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='件重' type='text' name='c02' id='c02'  lay-verType="tips">
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>包装</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='包装' type='text' name='c03' id='c03'  lay-verType="tips">
				</div>
				</div>
			</div>
			<div class='layui-form-item'>
				<div class='layui-inline'>
				<label class='layui-form-label'>打印规格</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='打印规格' type='text' name='printgg' id='printgg' >
				</div>
				</div>
<!--			</div>-->
<!--			<div class='layui-form-item'>-->
				<div class='layui-inline'>
				<label class='layui-form-label'>备注</label>
				<div class='layui-input-block'>
					<input class='layui-input' placeholder='备注' type='text' name='memo' id='memo' >
				</div>
				</div>
			</div>

			<div class="form-actions">
				<div class="row" align="center">
					<div class="col-md-12">
<!--					    <button class="layui-btn" onclick="javascript:history.back(-1);">返回</button>-->
						<button id="btnclose" class="layui-btn">关闭</button>
						<button class="layui-btn" lay-submit  lay-filter="tj" id="tj">
							<i class="fa fa-save"></i> 保存
						</button>
					</div>
				</div>
			</div>
		</form>
	</div>
</div>
</div>
	<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/jq.js"></script>
    <script type="text/javascript" src="../../js/chfl.js"></script>
	<!--<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>-->
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../layui/layui.js"></script>
	<script type="text/javascript" src="../../js/dict.js"></script>
	<script type="text/javascript">
        showDictSelect("unit1", "danwei", true)
	//var appStatus = showStepSelect("stepid", "1", true);
    // showChflSelect("invcid", "chfl", false);

    var invcid = getUrlParam("invcid");
console.log("add" + invcid);

    //$("#invcid").val("");   下拉树选中该节点
	$("#invcid").data("invcid",invcid);

	if(invcid && !getUrlParam("id")){
		$.ajax({
			type : 'get',
			url : '/chdas/invnameByChfl/'+invcid,
			async : false,
			success : function(data) {
				if (data) $("#invname").val(data)
			}
		})
	}

    layui.config({
        base: '../../layuiadmin/eleTree/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
    }).extend({
        eleTree: 'eleTree'
    });

        var el;
		layui.use(['layer','form','laydate','eleTree'], function(){

		    var layer = layui.layer;
            var form = layui.form;
            var eleTree = layui.eleTree;

            if(!el){
                el=eleTree.render({
                    elem: '.eleTree',
                    url:'/chdas/eleTree',
                    request: {
                        name: "name",
                    },
                    emptText:"暂无分类",
                    // defaultExpandAll: true,
                    expandOnClickNode: false,
                    highlightCurrent: true,
                    done:function(res){
						var data = res.data;
						var id = getUrlParam("id");
						if(!id){
							if (invcid != 'undefined'){
								el.setChecked("[" + invcid +"]",true);
								// console.log(getUrlParam("pid") + getUrlParam("pname") + getUrlParam("ppath"));
								$("#invcid").data("id",getUrlParam("pid"));
								$("#invcid").val(decodeURI(getUrlParam("pname")));
								$("#ppath").val(getUrlParam("ppath"));
							}
						}
                        // // console.log(data)
                        // for(var i=0;i<data.length;i++){
                        //     if (data[i].id == invcid){
                        //         $("#invcid").data("invcid",data[i].id);
                        //         $("#invcid").val(data[i].name);
						// 		$("#ppath").val(getUrlParam("ppath"));
                        //     }
                        // }
                    }
                });
            }
            $("#invcid").on("click",function (e) {
                e.stopPropagation();
                $(".eleTree").toggle();
            });

            eleTree.on("nodeClick(eleTree)",function(d) {
                $('#invcid').trigger('change');
                $("#invcid").val(d.data.currentData.name);
                $("#invcid").data("invcid",d.data.currentData.id);
				$("#ppath").val(d.data.currentData.ppath);
                $(".eleTree").hide();
            });
            $(document).on("click",function() {
                $(".eleTree").hide();
            });

			initData();


			function initData(){
				var id = getUrlParam("id");
				if(id != "" && id != undefined){
					$.ajax({
						type : 'get',
						url : '/chdas/'+id,
						async : false,
						success : function(data) {
							console.log(data);
							$('#id').val(data.id);
							// $('#pid').val(data.pid);
							/*$('#xtid').val(data.xtid);*/
							$('#lbid').val(data.lbid);
							$('#invcode').val(data.invcode);
							$('#invname').val(data.invname);
							$('#invabbname').val(data.invabbname);
							$('#invstd').val(data.invstd);
							// $('#invcid').val(data.invcid);
							$("#invcid").data("invcid",data.invcid);
							$("#invcid").val(data.invcname);
							$("#ppath").val(data.ppath);
							$('#positionid').val(data.positionid);
							$('#iweight').val(data.iweight);
							$('#ivolume').val(data.ivolume);
							$('#iprice').val(data.iprice);
							$('#viprice').val(data.viprice);
							$('#icost').val(data.icost);
							$('#safenum').val(data.safenum);
							$('#topnum').val(data.topnum);
							$('#lownum').val(data.lownum);
							$('#unit1').val(data.unit1);
							$('#unit2').val(data.unit2);
							$('#pic').val(data.pic);
							$('#barcode').val(data.barcode);
							$('#bomid').val(data.bomid);
							$('#tdesc').val(data.tdesc);
                            $('#printgg').val(data.printgg);
							$('#memo').val(data.memo);
							$('#ctype').val(data.ctype);
							$('#c01').val(data.c01);
							$('#c02').val(data.c02);

							renderForm();       //重新渲染表单
						}
					});

				}
			}

            form.on('submit(tj)', function(data){

                $("#tj").attr("class","layui-btn layui-btn-radius layui-btn-disabled").removeAttr("lay-filter","tj");

                var formdata = $("#form").serializeObject();

                formdata.invcid = $("#invcid").data("invcid");

				var posttype = "post";
				if(getUrlParam("id")){
					posttype = "put";
				}
				$.ajax({
					type : posttype,
                    url : '/chdas',
                    contentType: "application/json; charset=utf-8",
                    data : JSON.stringify(formdata),
                    success : function(data) {
                        layer.msg("保存成功", {shift: -1, time: 1000}, function(){
                            // location.href = "smlist.html";
							$("#btnclose").trigger('click');
                        });
                    }
                });

                return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
            });



            //重新渲染表单
            function renderForm(){
                layui.use('form', function(){
                    var form = layui.form;//高版本建议把括号去掉，有的低版本，需要加()
                    form.render();
                });
            }


        });

		$("#btnclose").click(function(){
			//当你在iframe页面关闭自身时
			var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
			parent.layer.close(index); //再执行关闭
		});
	</script>
</body>
</html>

