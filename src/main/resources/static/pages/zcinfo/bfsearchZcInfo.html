<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/eleTree/eleTree.css" media="all">
    <script type="text/javascript" src="../../js/xm-select.js"></script>
    <!--<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">-->
    <style>
        .eleTree{
            width: 450px;
            height: 500px;
            border: 1px solid #ccc;
            overflow: hidden;
            display: inline-block;
        }
        .ele5{
            height: auto;
            width: 130%;
            display: none;
            position: absolute;
            top:100%;
            background-color: #fff;
            z-index: 1000;
        }
        .layui-form-label{
            width: 100px;
        }
    </style>
</head>
<body>

<div class="layui-fluid">
    <div class="layui-col-space15" style="height:100%;">
        <!--资产类别-->
        <!--<div class="layui-col-md3" style="height:100%;" id="zcCategoryTree">-->
        <!--<div class="layui-card" style="height:100%;">-->
        <!--<div class="layui-card-header">资产类别</div>-->
        <!--<div class="layui-card-body">-->
        <!--&lt;!&ndash;<div class="layui-carousel layadmin-carousel layadmin-dataview" data-anim="fade" lay-filter="LAY-index-normcol">&ndash;&gt;-->
        <!--<div id="eleTree" lay-filter="eleTree"></div>-->
        <!--&lt;!&ndash;</div>&ndash;&gt;-->
        <!--</div>-->
        <!--</div>-->
        <!--</div>-->
        <div class="layui-col-md12" style="height:100%">
            <!--资产列表-->
            <div class="layui-card">
                <div class="layui-form layui-card-header layuiadmin-card-header-auto">
                    <div class="layui-form-item">
                        <form>
                        <input id="token" name="token" type="hidden"/>
                        <div class="layui-inline">
                            <label class="layui-form-label">资产追溯码</label>
                            <div class="layui-input-inline">
                                <input id="epcid" name="epcid" type="text" class="form-control layui-input"
                                       placeholder="资产追溯码">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">资产编码</label>
                            <div class="layui-input-inline">
                                <input id="zcCodenum" name="zcCodenum" type="text" class="form-control layui-input"
                                       placeholder="资产编码">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">资产名称</label>
                            <div class="layui-input-inline">
                                <input id="zcName" name="zcName" type="text" class="form-control layui-input"
                                       placeholder="资产名称">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">分类</label>
                            <div class="layui-input-inline">
                                <div id="selectCategory"></div>
                            </div>
                            <!--<div class="layui-input-inline">-->
                                <!--<input class="layui-input" type="text" id="zcCategoryName" data-id="" placeholder="请选择资产分类" readonly="" autocomplete="off">-->
                                <!--<div class="eleTree ele5" id="zcCategoryEleTree" lay-filter="zcCategoryEleTree"></div>-->
                                <!--<input class="layui-input" type="hidden" id="zcCategoryId" name="zcCategoryId">-->
                            <!--</div>-->
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">规格</label>
                            <div class="layui-input-inline">
                                <input id="specification" name="specification" type="text"
                                       class="form-control layui-input" placeholder="规格">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">型号</label>
                            <div class="layui-input-inline">
                                <input id="model" name="model" type="text" class="form-control layui-input"
                                       placeholder="型号">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">开始使用日期</label>
                            <div class="layui-input-inline">
                                <input id="sdate" name="sdate" type="text" class="form-control layui-input"
                                       placeholder="开始使用日期">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;至</label>
                            <div class="layui-input-inline">
                                <input id="edate" name="edate" type="text" class="form-control layui-input"
                                       placeholder="终止日期">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">资产状态</label>
                            <div class="layui-input-inline">
                                <select id="useStatus" name="useStatus" type="text">
                                    <option value="">请选择资产状态</option>
                                    <option value="1">在用</option>
                                    <option value="2">闲置</option>
                                    <option value="3">拟报废</option>
                                    <option value="4">流失</option>
                                    <option value="5">调拨</option>
                                    <option value="6">报修</option>
                                    <option value="7">已报废</option>
                                </select>
                            </div>
                        </div>
                        <div class='layui-inline'>
                            <label class='layui-form-label'>管理部门</label>
                            <div class="layui-input-inline">
                                <div id="checkDept"></div>
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">原价值</label>
                            <div class="layui-input-inline">
                                <input id="originalValue" name="originalValue" type="text"
                                       class="form-control layui-input" placeholder="原价值">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">净值</label>
                            <div class="layui-input-inline">
                                <input id="netvalue" name="netvalue" type="text" class="form-control layui-input"
                                       placeholder="净值">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">使用月限</label>
                            <div class="layui-input-inline">
                                <input id="useMonths" name="useMonths" type="text" class="form-control layui-input"
                                       placeholder="使用月限">
                            </div>
                        </div>
                        <div class="layui-inline">
                            <label class="layui-form-label">剩余月限</label>
                            <div class="layui-input-inline">
                                <input id="remainingperiod" name="remainingperiod" type="text"
                                       class="form-control layui-input" placeholder="剩余月限">
                            </div>
                        </div>
                        <div class='layui-inline'>
                            <button type="button" class="layui-btn layuiadmin-btn-useradmin" lay-submit lay-filter="LAY-user-front-search" id="searchBt">
                                <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>
                            </button>
                            <button type="reset" class="layui-btn layuiadmin-btn-useradmin" lay-submit
                                    lay-filter="LAY-user-front-search" >
                                <i class="layui-icon layui-icon-refresh-3 layuiadmin-button-btn"></i>
                            </button>
                        </div>
                        </form>
                    </div>
                    <div class="layui-inline demoTable">
                        <!--<button class="layui-btn layuiadmin-btn-useradmin" lay-submit lay-filter="LAY-user-front-search" id="searchBt">-->
                        <!--<i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>-->
                        <!--</button>-->
                        <button class="layui-btn"  data-type="save">保存</button>
                        <button class="layui-btn"  data-type="next">保存并继续添加</button>
                        <button type="reset" class="layui-btn layui-btn-primary" data-type="close">关闭</button>
                    </div>
                </div>

                <!--资产内容区-->
                <div class="layui-card-body">
                    <table class="layui-hide" id="data" lay-filter="data"></table>
                </div>
                <!--<div class="layui-form-item layui-layout-admin">-->
                <!--<div class="layui-input-block">-->
                <!--<div class="layui-footer demoTable" style="left: 0;">-->
                <!--<button class="layui-btn"  data-type="save">保存</button>-->
                <!--<button type="reset" class="layui-btn layui-btn-primary" data-type="close">关闭</button>-->
                <!--</div>-->
                <!--</div>-->
                <!--</div>-->
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/dict.js"></script>
<script type="text/javascript">

    var useStatus = showDictSelect("status", "useStatus", true);
    var tableIns;
    var el,el1;
    var catId;
    var catCode
    //var type = getUrlParam("type");
    layui.config({
        base: '../../layuiadmin/eleTree/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
    }).extend({
        eleTree: 'eleTree'
    })


    layui.use(['layer','form','laydate','table','eleTree'], function(){

        var layer = layui.layer;
        var form = layui.form;
        var laydate = layui.laydate;
        var table = layui.table;

        laydate.render({
            elem: '#sdate'
        });
        laydate.render({
            elem: '#edate'
        });

        tableIns = table.render({
            elem: '#data'
            ,url:"/zcInfos/bflayuiList"
            ,limit: 20
            ,limits: [20,40,50,100,200,500,1000,2000]
            ,height:  'full-240'
            ,even: true //开启隔行背景
            ,size: 'sm' //小尺寸的表格
            ,autoSort:false
            ,where: {zcName:$('#zcName').val(),bf:'0'}
            ,page: true
            ,request: {
                pageName: 'offset' //页码的参数名称，默认：page
            }
            ,cols: [[
                {field:'checkbox',checkbox: true} //其它参数在此省略
                ,{field:'id',hide:true}
                // ,{field:'cardNum',title:'卡片编号', width:150, sort: true}
                // ,{field:'zcCodenum',title:'资产编号', width:100, sort: true}
                ,{field:'epcid',title:'资产追溯码', width:130, sort: true}
                ,{field:'zcCodenum',title:'资产编码', width:150, }
                ,{field:'zcName',title:'资产名称', width:130,}
                // ,{field:'zc_coding',title:'资产编号', width:150, sort: true}
                //,{field:'zcCategoryName',title:'资产分类', width:100,}
                ,{field:'cateName1',title:'资产1级分类', width:100,}
                ,{field:'cateName2',title:'资产2级分类', width:100,}
                ,{field:'cateName3',title:'资产3级分类', width:100,}
                ,{field:'specification',title:'规格', width:100, sort: true}
                ,{field:'model',title:'型号', width:100, sort: true}
                ,{field:'startUseTime',title:'开始使用日期', width:110,}
                ,{field:'unit',title:'单位', width:100, sort: true}
                ,{field:'useStatus',title:'使用状态', width:100, sort: true,templet: function(d){
                        return useStatus[d.useStatus];
                    }}
                ,{field:'glDeptName',title:'管理部门', width:150, sort: true}
                ,{field:'syDeptName',title:'使用部门', width:150, sort: true}
                ,{field:'originalValue',title:'原价值', width:100, sort: true}
                ,{field:'netvalue',title:'净值', width:100, sort: true}
                ,{field:'useMonths',title:'使用月限', width:100, sort: true}
                ,{field:'remainingperiod',title:'剩余期限', width:100, sort: true}

                ,{field:'syName',title:'使用人', width:100, sort: true}
                ,{field:'storeAddress',title:'存放地点', width:100, sort: true}
                ,{field:'maintainCycle',title:'维护周期/天', width:100, sort: true}
                ,{field:'inspectTime',title:'巡检周期', width:100, sort: true}
                ,{field:'zcFrom',title:'资产来源', width:100, sort: true}

                ,{field:'ljZhejiu',title:'累计折旧', width:100, sort: true}
                ,{field:'bnZhejiu',title:'本年折旧', width:100, sort: true}

                ,{field:'jzzb',title:'减值准备', width:100, sort: true}
                ,{field:'net',title:'净额', width:100, sort: true}
                ,{field:'netResidualRate',title:'净残值率', width:100, sort: true}
                ,{field:'netResidualValue',title:'净残值', width:100, sort: true}
                ,{field:'haveCount',title:'已计提期数', width:100, sort: true}
                ,{field:'cname',title:'服务商名称', width:100, sort: true}
                ,{field:'venperson',title:'联系人', width:100, sort: true}
                ,{field:'venphone',title:'联系方式', width:100, sort: true}
                ,{field:'venaddress',title:'服务商地址', width:100, sort: true}
                ,{field:'warrantyperiod',title:'保修期限', width:100, sort: true}
                ,{field:'creator',title:'创建人', width:100, sort: true}
                ,{field:'createTime',title:'创建时间', width:150, sort: true}
                ,{field:'bz',title:'备注', width:100, sort: true}
            ]]
        });

        var eleTree = layui.eleTree;
        el = eleTree.render({
            elem: '#eleTree',
            url:'/zcCategorys/eleTree',
            request: {
                name: "name",
            },
            emptText:"暂无组织架构",
            highlightCurrent:true,
            // accordion:true,
            // showCheckbox:true,
            // checkOnClickNode:true,
            // accordion:true
        });
        // 节点点击事件
        eleTree.on("nodeClick(eleTree)",function(d) {
            //console.log(d.data.currentData.id);    // 点击节点对于的数据
            catId = d.data.currentData.id;
            catName = d.data.currentData.name;
            catCode = d.data.currentData.catCode;
            $('#searchBt').trigger('click');
        })
        // 查询管理部门
        if(!el1){
            el1=eleTree.render({
                elem: '#syDeptEleTree',
                url:'/depts/eleTree',
                request: {
                    name: "name",
                },
                emptText:"暂无管理部门",
                // defaultExpandAll: true,
                expandOnClickNode: false,
                highlightCurrent: true,
                done:function(res){
                }
            });
        }
        eleTree.on("nodeClick(syDeptEleTree)",function(d) {
            $('#syDeptName').trigger('change');
            $("#syDeptName").val(d.data.currentData.name)
            $("#syDeptId").val(d.data.currentData.id);
            $(".eleTree").hide();
        })
        $("#syDeptName").on("click",function (e) {
            e.stopPropagation();
            $(this).next(".eleTree").toggle();
        })

        //监听排序事件
        table.on('sort(data)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
            tableIns.reload({
                initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。
                ,where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                    zcName:$('#zcName').val(),
                    orderBy: "order by " + obj.field + " " + obj.type//排序字段 + 排序方式
                }
                ,page:{curr:1}
            });
        });

        active = {
            save: function(){ //保存
                var checkStatus = table.checkStatus('data')
                    ,data = checkStatus.data;
                //parent.$('#shuzhi').val(JSON.stringify(data));
                var temp = parent.$('#shuzhi').val();
                var newData = JSON.parse(temp);
                if (data && data.length > 0) {
                    $.each(data, function (index, item) {
                        if (!checkRepeat(newData,item)) {
                            newData.push(item);
                        }
                    })
                }
                parent.$('#shuzhi').val(JSON.stringify(newData))
                //当你在iframe页面关闭自身时
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.close(index); //再执行关闭
            },
            close: function() { //关闭
                var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
                parent.layer.close(index); //再执行关闭
            },
            next: function() { //保存并下一个
                // 添加数据
                var checkStatus = table.checkStatus('data')
                    ,data = checkStatus.data;
                var temp = parent.$('#shuzhi').val();
                var newData = JSON.parse(temp);
                if (data && data.length > 0) {
                    $.each(data, function (index, item) {
                        if (!checkRepeat(newData,item)) {
                            newData.push(item);
                        }
                    })
                }
                parent.$('#shuzhi').val(JSON.stringify(newData));
                tableIns.reload({data: data});
            }
        };

        $('.demoTable .layui-btn').on('click', function(){
            var type = $(this).data('type');
            active[type] ? active[type].call(this) : '';
        });

        // 选择分类
        $.ajax({
            url: '/zcCategorys/eleTree',
            contentType: "application/json; charset=utf-8",
            success: function (data) {
                // 资产分类
                selectZcCategory = xmSelect.render({
                    name: 'aaaaaa',
                    //layVerify: 'required',
                    //layVerType: 'msg',
                    el: '#selectCategory',
                    autoRow: true,
                    filterable: true,
                    radio: true,
                    //显示为text模式
                    model: { label: { type: 'text' } },
                    tree: {
                        show: true,
                        showFolderIcon: true,
                        showLine: true,
                        indent: 20,
                        expandedKeys: [ -3 ],
                    },
                    filterable: true,
                    height: 'auto',
                    //处理方式
                    // on: function(data){
                    //     if(data.isAdd){
                    //         return data.change.slice(0, 1)
                    //     }
                    // },
                    prop: {
                        value: 'id',
                    },
                    data: data.data
                })

            }
        });

        $.ajax({
            url : '/depts/eleTreeSelf',
            contentType: "application/json; charset=utf-8",
            success : function(data) {
                checkDeptselect=	xmSelect.render({
                    el: '#checkDept',
                    language: 'zn',
                    icon: 'hidden',
                    name: 'checkDeptId',
                    radio: true,
                    paging: true,
                    pageSize: 6,
                    prop: {
                        value: 'id',
                    },
                    // tree: {
                    // 	show: true,
                    // 	showFolderIcon: true,
                    // 	showLine: true,
                    // 	indent: 15,
                    // 	expandedKeys: [ -3 ],
                    // },
                    filterable: true,
                    height: 'auto',
                    data:data.data
                })
                //	checkDeptName.update({data:data.data});
            }
        });
    });

    $("#searchBt").click(function(){
        tableIns.reload({where: {
              //  zcName:$('#zcName').val(),
              //  syDeptId:checkDeptselect.getValue('valueStr'),
              //  zcCodenum:$('#zcCodenum').val(),
              //  cardNum:$('#cardNum').val(),

                epcid: $("#epcid").val(),
                zcCodenum: $('#zcCodenum').val(),
                zcName: $('#zcName').val(),
                zcCategoryId:$('#zcCategoryId').val(),
                specification: $("#specification").val(),
                model: $("#model").val(),
                sdate: $("#sdate").val(),
                edate: $("#edate").val(),
                useStatus: $("#useStatus").val(),
                glDeptId: checkDeptselect.getValue('valueStr'),
                originalValue: $("#originalValue").val(),
                netvalue: $("#netvalue").val(),
                useMonths: $("#useMonths").val(),
                remainingperiod: $("#remainingperiod").val(),


                catId:catId,
                catCode:catCode
            },
            page:{curr:1}
        })
    });

    // 判断报废子单是否重复
    function checkRepeat(array,item) {
        //var id = item[0].id;
        var id = item.id;
        for (var i = 0; i < array.length; i++) {
            if (array[i].id == id){
                return true;
            }
        }
        return false;
    }
</script>