<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">
<link rel="stylesheet" href="../../css/font-awesome/css/font-awesome.css" media="all" />
	<style>
		.eleTree{
			width: 350px;
			height: 500px;
			border: 1px solid #ccc;
			overflow: hidden;
			display: inline-block;
		}
		.ele5{
			height: auto;
			width: 98%;
			display: none;
			position: absolute;
			top:100%;
			background-color: #fff;
			z-index: 100;
		}
	</style>
</head>
<body>
<div class="layui-fluid">
	<div class="layui-card">
		<div class="layui-card-header" align="center" ><h1>编辑客户档案</h1></div>
		<div class="layui-card-body">
			<form  class="layui-form layui-form-pane" onsubmit="return false" id="form">
				<input type="hidden" id="id" name="id">
				<input type="hidden" id="ppath" name="ppath">
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<label class='layui-form-label'>客户分类</label>
						<div class='layui-input-block'>
							<!--<select placeholder='存货分类' type='text' name='pid' id='pid' lay-verify="required"
									lay-verType="tips">
							</select>-->
							<input class="layui-input" type="text" id="cid" name="cid" data-id=""  placeholder="请选择客户分类" readonly="" autocomplete="off">
							<div class="eleTree ele5" lay-filter="eleTree"></div>
						</div>
					</div>
<!--					<div class='layui-inline'>-->
<!--						<label class='layui-form-label'>客户编码</label>-->
<!--						<div class='layui-input-block'>-->
<!--							<input class='layui-input' placeholder='客户编码' type='text' name='ccode' id='ccode' lay-verify="required" lay-verType="tips">-->
<!--						</div>-->
<!--					</div>-->
					<div class='layui-inline'>
						<label class='layui-form-label'>客户名称</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='客户名称' type='text' name='cname' id='cname' lay-verify="required" lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>联系人</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='联系人' type='text' name='cperson' id='cperson' lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>备注</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='备注' type='text' name='memo' id='memo' >
						</div>
					</div>



				</div>

				<div class='layui-form-item'>
					<div class='layui-inline'>
						<label class='layui-form-label'>电话</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='电话' type='text' name='cphone' id='cphone'  >
							<!--							lay-verify="number"-->
						</div>
					</div>

					<div class='layui-inline'>
						<label class='layui-form-label'>电话2</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='电话2' type='text' name='cfax' id='cfax'>
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>电话3</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='电话3' type='text' name='cemail' id='cemail' >
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>电话4</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='电话4' type='text' name='cpostcode' id='cpostcode' lay-verType="tips">
						</div>
					</div>
				</div>
				<div style="width:100%;height:1px;border: 1px solid #eee"></div>
				<span  id="zkbtn" class="layui-icon layui-icon-down"></span>
            <div id="zkdiv" style="display: none;">
				<div class='layui-form-item'>

					<div class='layui-inline'>
						<label class='layui-form-label'>客户简称</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='客户简称' type='text' name='abbname' id='abbname' lay-verType="tips">
						</div>

					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>银行</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='银行' type='text' name='cbank' id='cbank'  lay-verType="tips" >
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>账号</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='账号' type='text' name='caccount' id='caccount' lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>客户类型</label>
						<div class='layui-input-block'>
							<select class="layui-input" name="ctype" id="ctype"></select>
						</div>
					</div>
				</div>

				<div class='layui-form-item'>


					<div class='layui-inline'>
						<label class='layui-form-label'>地址</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='地址' type='text' name='caddress' id='caddress'  lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>法人</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='法人' type='text' name='legalperson' id='legalperson'>
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>信用额度</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='信用额度' type='text' name='xinyong' id='xinyong' >
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>回款周期</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='回款周期' type='text' name='shuilv' id='shuilv' >
						</div>
					</div>

				</div>
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<label class='layui-form-label'>企业代码</label>
						<div class='layui-input-block'>
							<input class='layui-input' placeholder='企业代码' type='text' name='cregcode' id='cregcode' lay-verType="tips">
						</div>
					</div>

				</div>
			</div>
				<div class="form-actions">
					<div class="row" align="center">
						<div class="col-md-12">
<!--							<button class="layui-btn" onclick="javascript:history.back(-1);">返回</button>-->
<!--							<button class="layui-btn" onclick="back()">返回</button>-->
							<button class="layui-btn" lay-submit  lay-filter="tj" id="tj">
								<i class="fa fa-save"></i> 保存
							</button>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
	<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
	<script type="text/javascript" src="../../js/jq.js"></script>
	<script type="text/javascript" src="../../js/common.js"></script>
	<script type="text/javascript" src="../../layui/layui.js"></script>
	<script type="text/javascript" src="../../js/dict.js"></script>
    <script type="text/javascript" src="../../js/customrclass.js"></script>
	<script type="text/javascript">

	//var appStatus = showStepSelect("stepid", "1", true);

    // showcustomerclasssSelect("pid", "customerclass", false);
    showDictNameSelect("ctype","custype",false);
    var pid = getUrlParam("pid");
    layui.config({
        base: '../../layuiadmin/eleTree/' //设定扩展的Layui模块的所在目录，一般用于外部模块扩展
    }).extend({
        eleTree: 'eleTree'
    });

    var el;
    layui.use(['layer','form','laydate','eleTree'], function(){

        var layer = layui.layer;
        var form = layui.form;
        var laydate =layui.laydate;

        laydate.render({
            elem: '#devdate' //指定元素
        });

        var eleTree = layui.eleTree;

        if(!el){
            el=eleTree.render({
                elem: '.eleTree',
                url:'/customers/eleTree',
                request: {
                    name: "name"
                },
                emptText:"暂无分类",
                // defaultExpandAll: true,
                expandOnClickNode: false,
                highlightCurrent: true,
                done:function(res){
                	// console.log(res.data);

					if (pid && pid != "undefined" && !getUrlParam("id")){
						el.setChecked("[" + pid +"]",true);

						// console.log(getUrlParam("pid") + getUrlParam("pname") + getUrlParam("ppath"));
						        $("#cid").data("id",pid);
						        $("#cid").val(decodeURI(getUrlParam("pname")));
						        $("#ppath").val(getUrlParam("ppath"));
					}
                    // var data = res.data;
                    // for(var i=0;i<data.length;i++){
                    //     if (data[i].id == pid){
                    //         $("#cid").data("id",data[i].id);
                    //         $("#cid").val(data[i].name);
                    //         $("#ppath").val(data[i].ppath);
                    //     }
					// 	if (data[i].id == cid){
					// 		$("#cid").data("id",data[i].id);
					// 		$("#cid").val(data[i].name);
					// 		$("#ppath").val(data[i].ppath);
					// 	}
                    // }
                }
            });
        }
        $("#cid").on("click",function (e) {
            e.stopPropagation();
            $(".eleTree").toggle();
        });


		initData();
		function initData(){
			var id = getUrlParam("id");

			if(id != "" && id != undefined){

				$.ajax({
					type : 'get',
					url : '/customers/'+id,
					async : false,
					success : function(data) {
						$('#id').val(data.id);
						$('#ccode').val(data.ccode);
						$('#cname').val(data.cname);
						$('#abbname').val(data.abbname);
						$("#cid").data("id",data.cid);
						$("#cid").val(data.classname);
						$("#ppath").val(data.ppath);
						$('#caddress').val(data.caddress);
						$('#cpostcode').val(data.cpostcode);
						$('#cregcode').val(data.cregcode);
						$('#cbank').val(data.cbank);
						$('#caccount').val(data.caccount);
						$('#devdate').val(data.devdate);
						$('#cperson').val(data.cperson);
						$('#cphone').val(data.cphone);
						$('#cfax').val(data.cfax);
						$('#cemail').val(data.cemail);
						$('#legalperson').val(data.legalperson);
						$('#pic').val(data.pic);
						$('#barcode').val(data.barcode);
						$('#tdesc').val(data.tdesc);
						$('#memo').val(data.memo);
						$('#ctype').val(data.ctype);
						$('#xinyong').val(data.xinyong);
						$('#shuilv').val(data.shuilv);
						renderForm();       //重新渲染表单
					}
				});

			}
		}

        eleTree.on("nodeClick(eleTree)",function(d) {
            $('#cid').trigger('change');
            $("#cid").val(d.data.currentData.name);
            $("#cid").data("id",d.data.currentData.id);
            $("#ppath").val(d.data.currentData.ppath);
            $(".eleTree").hide();
        });
        $(document).on("click",function() {
            $(".eleTree").hide();
        });

        form.on('submit(tj)', function(data){
            $("#tj").attr("class","layui-btn layui-btn-radius layui-btn-disabled").removeAttr("lay-filter","tj");
            var formdata = $("#form").serializeObject();
            formdata.cid = $("#cid").data("id");
			var posttype = "post";
			if(getUrlParam("id")){
				posttype = "put";
			}
            $.ajax({
                type : posttype,
                url : '/customers',
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(formdata),
                success : function(data) {
                    layer.msg("保存成功", {shift: -1, time: 1000}, function(){
                        // javascript:history.back(-1);
						// location.href = "customerList.html";
						var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
						parent.layer.close(index); //再执行关闭

						// if(posttype=="put"){
						// 	parent.layui.admin.events.closeThisTabs();
						// }else {
						// 	if (getUrlParam("searchCus")){
						// 		location.href = "customerList.html?searchCus=true";
						// 	}else {
						// 		location.href = "customerList.html";
						// 	}
						// }

                    });
                }
            });

            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });

        //重新渲染表单
        function renderForm(){
            layui.use('form', function(){
                var form = layui.form;//高版本建议把括号去掉，有的低版本，需要加()
                form.render();
            });
        }


    });

    $("#zkbtn").click(function(){
        $("#zkdiv").slideToggle(function(){
            if ($("#zkbtn").hasClass("layui-icon-up")) {
                $("#zkbtn").addClass("layui-icon-down").removeClass("layui-icon-up")
			}else{
                $("#zkbtn").addClass("layui-icon-up").removeClass("layui-icon-down")
			}
		});
	});
		function back() {
			if (getUrlParam("searchCus")){
				location.href = "customerList.html?searchCus=true";
			}else {
				location.href = "customerList.html";
			}
		}
	</script>
</body>
</html>
