<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/addphoto.css">
<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
<!--<link rel="stylesheet" type="text/css" media="screen" href="../../layui/css/layui.css">-->
	<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all" />
<link rel="stylesheet" href="../../css/font-awesome/css/font-awesome.css" media="all" />
</head>
<body>
<div class="layui-fluid">
	<div class="layui-card">
<!--		<div class="layui-card-header" align="center" ><h1>付款申请</h1></div>-->
		<div class="layui-card-body">
			<form class="layui-form layui-form-pane" onsubmit="return false" id="form">
				<div class="form-actions">
					<div class="row">
						<div class="col-md-12">
							<button class="layui-btn" onclick="location.href='fukuanshenqingList.html'">返回</button>
							<button class="layui-btn"  lay-submit  lay-filter="tj" id="tj">
								<i class="fa fa-save"></i> 保存
							</button>
						</div>
					</div>
				</div>
				<hr style="height:3px;">

				<!--<div class='layui-form-item'>-->
					<!--&lt;!&ndash;<label class='layui-form-label'>单据编码</label>&ndash;&gt;-->
					<!--&lt;!&ndash;<div class='layui-input-block'>&ndash;&gt;-->
						<!--&lt;!&ndash;<input class='layui-input' placeholder='单据编码' type='text' name='ccode' id='ccode' lay-verify="required" lay-verType="tips">&ndash;&gt;-->
					<!--&lt;!&ndash;</div>&ndash;&gt;-->
				<!--</div>-->
				<input id="gongyingshang" style="display: none;"/>
				<div class='layui-form-item'>
					<div class='layui-inline'>
						<label class='layui-form-label'>日期</label>
						<div class='layui-input-inline'>
							<input class='layui-input' placeholder='日期' type='text' name='ddate' id='ddate' lay-verify="required" lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>付款方式</label>
						<div class='layui-input-inline'>
							<select class="layui-input" name="fkfs" id="fkfs">
								<option value="对公账户">对公账户</option>
								<option value="其他账户">农行</option>
								<option value="其他账户">建行</option>
								<option value="其他账户">工行</option>
								<option value="其他账户">中行</option>
								<option value="其他账户">邮政</option>
								<option value="其他账户">信用社</option>
								<option value="其他账户">微信</option>
							</select>
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>供应商</label>
						<div class='layui-input-inline'>
							<input class='layui-input' placeholder='供应商' type='text' name='ksmc' id='ksmc' readonly onclick="tianjiaGys()">
							<input class='layui-input' placeholder='供应商ID' type='hidden' name='ksid' id='ksid' >
						</div>
					</div>


				</div>
				<!--<div class='layui-form-item'>-->
					<!--<label class='layui-form-label'>业务类型</label>-->
					<!--<div class='layui-input-block'>-->
						<!--<input class='layui-input' placeholder='业务类型' type='text' name='busstype' id='busstype' lay-verify="required" lay-verType="tips">-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class='layui-form-item'>-->
					<!--<label class='layui-form-label'>单据来源</label>-->
					<!--<div class='layui-input-block'>-->
						<!--<input class='layui-input' placeholder='单据来源' type='text' name='csource' id='csource' lay-verify="required" lay-verType="tips">-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class='layui-form-item'>-->
					<!--<label class='layui-form-label'>对应业务单号</label>-->
					<!--<div class='layui-input-block'>-->
						<input class='layui-input' placeholder='对应业务单号' type='hidden' name='bussid' id='bussid' >
					<!--</div>-->
				<!--</div>-->

				<div class='layui-form-item'>
					<div class='layui-inline'>
						<label class='layui-form-label'>付款项目</label>
						<div class='layui-input-inline'>
							<input class='layui-input' placeholder='付款项目' type='text' name='fkxm' id='fkxm' lay-verify="required" lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>付款金额</label>
						<div class='layui-input-inline'>
							<input class='layui-input' placeholder='付款金额' type='text' name='fkje' id='fkje' lay-verify="required" lay-verType="tips">
						</div>
					</div>
					<div class='layui-inline'>
						<label class='layui-form-label'>备注</label>
						<div class='layui-input-inline'>
							<input class='layui-input' placeholder='备注' type='text' name='memo' id='memo' >
						</div>
					</div>
				</div>
				<div class='form-group'>
					<div class='col-md-2'></div>
					<div class='col-md-5'>
						<button type="button" class="layui-btn" id="test2">图片上传</button>
						<blockquote class="layui-elem-quote layui-quote-nm" style="margin-top: 10px;width: 88%">
							<div class="layui-upload-list uploader-list" style="overflow: auto;" id="uploader-list">

							</div>
						</blockquote>

					</div>
				</div>
				<!--<div class='layui-form-item'>-->
					<!--<label class='layui-form-label'>业务类型</label>-->
					<!--<div class='layui-input-block'>-->
						<!--<input class='layui-input' placeholder='业务类型' type='text' name='ctype' id='ctype' lay-verify="required" lay-verType="tips">-->
					<!--</div>-->
				<!--</div>-->
				<!--<div class='layui-form-item'>
                    <label class='layui-form-label'>流程</label>
                    <div class='layui-input-block'>
                        <input class='layui-input' placeholder='流程' type='text' name='flowid' id='flowid' >
                    </div>
                </div>
                <div class='layui-form-item'>
                    <label class='layui-form-label'>节点</label>
                    <div class='layui-input-block'>
                        <input class='layui-input' placeholder='节点' type='text' name='stepid' id='stepid' >
                    </div>
                </div>-->

			</form>
		</div>
	</div>
</div>
<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="../../js/dict.js"></script>
<script type="text/javascript" src="../../js/vendor.js"></script>
<script type="text/javascript">

    //var appStatus = showStepSelect("stepid", "1", true);
    // showDictNameSelect("fkfs", "fktype",false);
    // showVenSelect("ksid", "vendor", false);
	var ids = [];	//文件数组
	var sum = 0;
    layui.use(['layer','form','laydate','upload'], function(){
        var layer = layui.layer;
        var form = layui.form;
		var laydate = layui.laydate;
		laydate.render({
			elem: '#ddate'
			,value: new Date()
		});

        initData();
        function initData(){
            var id = getUrlParam("ddid");
            if(id != ""){
                $.ajax({
                    type : 'get',
                    url : '/cgDingdans/'+id,
                    async : false,
                    success : function(data) {
                    	// console.log(data);
                        $('#id').val(data.id);
                        $('#ccode').val(data.ccode);
                        $('#ddate').val(data.ddate);
                        $('#busstype').val(data.busstype);
//                        $('#csource').val(data.csource);
                        $('#bussid').val(data.id);
//                        $('#whid').val(data.whid);
//                        $('#deptid').val(data.deptid);
                        $('#ksid').val(data.ksid);
						$('#ksmc').val(data.ksmc);
//                        $('#inum').val(data.inum);
//                        $('#taxrate').val(data.taxrate);
//                        $('#tax').val(data.tax);
//                        $('#imoney').val(data.imoney);
						if(getUrlParam("type")=="2"){
							$('#fkxm').val("付运费款");
							$('#fkje').val(data.yfje);
						}else{
							if(data.tax == null || data.tax ==""){
								$("#fkfs").val("其他账户");
							}else {
								$("#fkfs").val("对公账户");
							}
							$('#fkxm').val("付物料款");
							$('#fkje').val(data.imoney);
						}

                        $('#memo').val($('#fkxm').val()+ data.ksmc + $('#fkje').val());
//                        $('#ctype').val(data.ctype);
//                        $('#flowid').val(data.flowid);
//                        $('#stepid').val(data.stepid);

                        renderForm();       //重新渲染表单
                    }
                });

            }
        }



        form.on('submit(tj)', function(data){

            $("#tj").attr("class","layui-btn layui-btn-radius layui-btn-disabled").removeAttr("lay-filter","tj");

            var formdata = $("#form").serializeObject();
            formdata.csource = "采购订单";

			if(formdata.memo==""){
				fromdata.memo = $('#fkxm').val() +  $("#ksid").find("option:selected").text() +$('#fkje').val();
			}
			formdata.fileIds=ids;
            $.ajax({
                type : 'post',
                url : '/fukuanshenqings',
                contentType: "application/json; charset=utf-8",
                data : JSON.stringify(formdata),
                success : function(data) {
                    layer.msg("添加成功", {shift: -1, time: 1000}, function(){
                        location.href = "fukuanshenqingList.html";
                    });
                }
            });

            return false; //阻止表单跳转。如果需要表单跳转，去掉这段即可。
        });

		//普通图片上传
		var upload = layui.upload;
		upload.render({
			elem: '#test2'
			,url: '/files/'
			,multiple: true
			,before: function(obj){
				layer.msg('图片上传中...', {
					icon: 16,
					shade: 0.01,
					time: 0
				})
				obj.preview(function(index, file, result){
//                        console.log(index);
//                        console.log(file);
//                        console.log(result);
					$('#uploader-list').append('<div id="" class="file-iteme">' +
							'<div class="handle"><span class="glyphicon glyphicon-trash"></span></div>' +
							'<img style="width: 220px;height: 180px;" src="'+ result +'" alt="'+ file.name +'" class="layui-upload-img">')
				});
			}
			,done: function(res){

				ids.push(res.id);
				// console.log($('#uploader-list img').last().attr("alt",res.id));
				// console.log(res);
				sum++;
				layer.close(layer.msg());//关闭上传提示窗口
			}
		});
		$(document).on("mouseenter mouseleave", ".file-iteme", function(event){
			if(event.type === "mouseenter"){
				//鼠标悬浮
				$(this).children(".info").fadeIn("fast");
				$(this).children(".handle").fadeIn("fast");
			}else if(event.type === "mouseleave") {
				//鼠标离开
				$(this).children(".info").hide();
				$(this).children(".handle").hide();
			}
		});
		// 删除图片
		$(document).on("click", ".file-iteme .handle", function(event){
			// $(this).parent().remove();
			console.log($(this).next().attr("alt"));
			del( $(this).parent(), $(this).next().attr("alt") ); //删除对应的文件

			sum--;
			if(sum<0){
				sum=0;
			}
		});


    });

	function tianjiaGys(){
		layer.open({
			type: 2,
			title: '添加供应商',
			shadeClose: true,
			shade: 0.8,
			area: ['70%', '70%'],
			content: '../vendor/vendorList.html?searchVen=true',
			end : function(){
				var gongyingshang = JSON.parse($("#gongyingshang").val());
				$("#ksid").val(gongyingshang.id);
				$("#ksmc").val(gongyingshang.cname);
			}
		});


	}
</script>
</body>
</html>
