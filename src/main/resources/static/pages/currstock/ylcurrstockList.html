<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Insert title here</title>
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <!--<link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">-->
    <link rel="stylesheet" type="text/css" media="screen" href="../../css/common.css">
</head>
<body>
<div>
    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12" id="main">
        <div>
            <header style="height: 100%">
                <div align="left">
                    <table style="width: 100%">
                        <tr>
                            <td style="height:50px">
                                <input id="kehu" type="hidden" />
                                <form class="form-inline " id="form" method="post" action="/stockinss/export" onsubmit="return false" enctype="multipart/form-data">
                                    <input id="token" name="token" type="hidden" />
                                    <div class="form-group">
                                        <span id="qitaCus">
                                            客户：
                                            <select id="cusid" name="cusid" class="form-control" style="width:200px"></select>
                                        </span>
                                        <span style="display: none" id="smCus">
                                            客户：
                                            <input class='form-control' placeholder='客户' type='text' style="width:100px" name='cusname' id='cusname'>
                                        </span>
                                        <span>
                                            仓库：
                                            <select id="whid" name="whid" class="form-control" lay-filter="whid"></select>
                                        </span>
                                        <span id="qitaCurr">
                                            存货：
                                             <input class='form-control' placeholder='存货' type='text' style="width:100px" name='invname' id='invname' >
                                        </span>
                                        <span style="display: none" id="smCurr">
                                            存货：
                                            <select id="invid" name="sminvname" class="form-control" lay-filter="inv"></select>
                                        </span>
                                        <span id="qitagg">
                                            规格：
                                            <input class='form-control' placeholder='规格' type='text' style="width:100px" name='cpgg' id='cpgg' >
                                        </span>
                                        <span style="display: none" id="smgg">
                                            规格：
                                            <div style="display: inline-block;"><input class='form-control' placeholder='规格' type='text' style="width:100px" name='smcpgg' id='smcpgg' ></div>
                                        </span>
                                        <!--<div class="layui-inline">-->
                                        <!--<label class="layui-form-label">状态</label>-->
                                        <!--<div class="layui-input-block">-->
                                        <!--<select id="status" name="status" class="form-control input-sm"></select>-->
                                        <!--</div>-->
                                        <!--</div>-->
                                        <span>
                                            开始日期：
                                            <input class='form-control' placeholder='开始时间' style="width:100px" type='text' name='sdate' id='sdate' >
                                        </span>
                                        <span>
                                            结束日期：
                                            <input class='form-control' placeholder='结束时间' style="width:100px" type='text' name='edate' id='edate' >
                                        </span>
                                        <span>
                                            类型：
                                            <select id="type" name="type" class="form-control"></select>
                                        </span>
                                        <button class="layui-btn layuiadmin-btn-useradmin layui-btn-sm" lay-submit lay-filter="LAY-user-front-search" id="searchBt">
                                            <i class="layui-icon layui-icon-search layuiadmin-button-btn"></i>搜索
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <form class="form-inline" onsubmit="return false">
                                    <div class="form-group">
                                        <button class="layui-btn layuiadmin-btn-useradmin layui-btn-sm" id="kclog">
                                            库存明细账
                                        </button>
                                        <button class="layui-btn layuiadmin-btn-useradmin layui-btn-sm" id="exportBt">
                                            导出
                                        </button>
                                        <button class="layui-btn layuiadmin-btn-useradmin layui-btn-sm" id="printBt">
                                            打印
                                        </button>
                                    </div>
                                </form>
                            </td>
                        </tr>
                    </table>
                </div>
            </header>

            <div>
                <div class="widget-body no-padding">
                    <table class="layui-hide" id="data" lay-filter="data"></table>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>
<div id="test"></div>
<script type="text/javascript" src="../../js/libs/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="../../js/jQuery.print.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="../../js/my/permission.js"></script>
<script type="text/javascript" src="../../js/warehouse.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../js/dict.js"></script>
<script type="text/javascript" src="../../js/inv.js"></script>
<script type="text/javascript" src="../../js/customer.js"></script>
<script type="text/javascript">
var pers = checkPermission();

var ctype = getUrlParam("ctype");
var ck = getUrlParam("ck");
if(ck){
    if(ck="dmfl"){
        $("#whid").append("<option value='12'>地膜辅料库</option>");
    }
}else {
    if (ctype == "bj") {
        showWarehouseByType("whid", "warehouse", false, "备件库");
    } else if (ctype == "yl") {
        showWarehouseByType("whid", "warehouse", false, "原料库");
    } else if (ctype == "yldept") {
        showWarehouseByType("whid", "warehouse", false, "原料库", "1");
    } else if (ctype == "cp") {
        showWarehouseByType("whid", "warehouse", false, "产品库", "1");
    } else if (ctype == "cpview") {
        showWarehouseByType("whid", "warehouse", false, "产品库", "0");
    } else if (ctype == "sm") {
        showWarehouseByType("whid", "warehouse", false, "产品库", "0");

        $("#whid").val(10);
        $("#qitaCus").hide();
        $("#smCus").show();
        $("#qitaCurr").hide();
        $("#smCurr").show();
        $("#qitagg").hide();
        $("#smgg").show();
        // $("#smcpgg").append("<option value=''>请选择</option>");

        var select = $("#invid");
        var whid = $("#whid").val();
        var invdata = getInvname(whid);
        select.append("<option value=''>请选择</option>");
        $.each(invdata, function (id, d) {
            select.append("<option value ='" + d.id + "'>" + d.name + "</option>");
        });

        layui.config({
            base: '../../layuiadmin/yutons_sug/' //设置自定义插件路径:根据实际路径进行设置
        }).use(['yutons_sug'], function () {
            //创建yutons_sug搜索框提示插件||输入框提示插件实例
            yutons_sug = layui.yutons_sug;

            //初始化标准输入提示框
            yutons_sug.render({
                id: 'smcpgg', //设置容器唯一id
                type: 'sug', //设置输入框提示类型：sug-下拉框，sugTable-下拉表格
                url: sessionStorage.getItem("url"), //设置异步数据接口,url为必填项,params为字段名
                brefore: function (optid) {
                    sessionStorage.setItem("url", "/invs/listcpgg?invname=" + $("#invid").val() + "&cpgg=");
                }
            });
            $("#sugItem").css({"z-index": "99999999"})
        });
    } else {
        showWarehouseSelect("whid", "warehouse", false);
    }
}
// var whStatus = showWarehouseSelect("whid", "whid", true);
// var biztype = getUrlParam("ctype");
// if(biztype == "bj") {
//     biztype="备件库";
//     showWarehouseByType("whid", "warehouse", false,biztype);
// }else if(biztype == "yl") {
//     biztype ="原料库";
//     showWarehouseByType("whid", "warehouse", false,biztype);
// }else if(biztype == "cp") {
//     biztype ="产品库";
//     showWarehouseByType("whid", "warehouse", false,biztype);
// }else{
//     showWarehouseSelect("whid", "warehouse", false);
// }
showDictSelect("status", "bjstatus",true);
showDictSelect("type", "kctype",undefined);
showCusSelect("cusid", "customer", true);
layui.use(['layer','upload','table','laydate','form'], function(){
    var form = layui.form;
    var layer = layui.layer;
    var upload = layui.upload;
    var table = layui.table;
    var laydate = layui.laydate;
    var date = new Date();
    var year = date.getFullYear();
    var month = date.getMonth()+1;

    laydate.render({
        elem: '#sdate',
        type: 'date',
        value: year +'-'+ month +'-'+ '01'
    });
    laydate.render({
        elem: '#edate'
        ,value: new Date()
    });

    tableIns = table.render({
        elem: '#data'
        ,url:"/currstocks/list2"
        ,limit: 40
        ,limits: [20,40,50,100,200,500,1000,2000]
        ,height:  'full-120'
        ,toolbar: true
//        ,skin: 'line' //行边框风格
//         ,even: true //开启隔行背景
//        ,size: 'sm' //小尺寸的表格
        ,autoSort:false
        ,where: {cusname:$('#cusname').val(),cusid:$('#cusid').val(),whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),inum:"00",orderBy:"order by createTime"}
        ,page: true
        ,totalRow: true
        ,request: {
            pageName: 'offset' //页码的参数名称，默认：page
        }
        ,cols: [[
            {field:'id',hide:true}
//             ,{field:'cusname',title:'客商',fixed:'left', width:150, sort: true, totalRowText: '合计'}
            // ,{field:'deptname',title:'部门',fixed:'left', width:150, sort: true}
            ,{field:'invname',title:'品名', width:200, sort: true}
//            ,{field:'cpgg',title:'规格', width:150, sort: true}
//            ,{field:'jian',title:'件', width:100, sort: true,totalRow: true}
            ,{field:'inum',title:'总公斤', width:100, sort: true,totalRow: true}
            ,{field:'iprice',title:'单价', width:100, sort: true}
            ,{field:'imoney',title:'金额', width:100, sort: true,totalRow: true}
//            ,{field:'danwei',title:'单位', width:150, sort: true}
//            ,{field:'ilen',title:'米数', width:100, sort: true,totalRow: true}
//            ,{field:'jianzhong',title:'单位重', width:100, sort: true,totalRow: true}
//            ,{field:'perlen',title:'单位长度', width:100, sort: true,totalRow: true}
//            ,{field:'creater',title:'制单人', width:80, sort: true}
            ,{field:'ddate',title:'日期', width:200, sort: true}
            ,{field:'memo',title:'备注', width:100, sort: true}
//            ,{field:'costprice',title:'进货单价', width:100, sort: true}
//            ,{field:'profit',title:'销售利润', width:100, sort: true,totalRow: true}
//            ,{field:'', title: '码单',fixed: 'right',width:60, templet: function(d){
//                    return "<i class='layui-icon layui-icon-search' style='cursor: pointer'  lay-event='madan'></i> "
//                }}
//            ,{field:'', title: '明细',fixed: 'right',width:60, templet: function(d){
//                    return "<i class='layui-icon layui-icon-search' style='cursor: pointer'  lay-event='kcmx'></i> "
//                }}
            // ,{field:'statusname',title:'状态', width:100, sort: true}
            // ,{field:'caozuo', title: '操作',fixed:'right', width:200,templet: function(d){
            //         var id = d.id;
            //         // var href = "updateCurrstock.html?id=" + id;
            //         // var edit = buttonEdit(href, "", pers);
            //         // var del = buttonDel(id, "", pers);
            //         var ruku = "<a onclick='rkmx(this)' data-invid='"+d.invid+"' data-cpgg='"+d.cpgg+"' lay-id=rukumx"+ d['id'] +" href=javascript:void(0)>【入库明细】</a>";
            //         var chuku = "<a onclick='ckmx(this)' data-invid='"+d.invid+"' data-cpgg='"+d.cpgg+"' lay-id=chukumx"+ d['id'] +" href=javascript:void(0)>【出库明细】</a>";
            //
            //         return ruku + chuku;
            //     }}
        ]]
        , done: function(){
            var type = $("#type").val();
            if (type == "3") {
                var heji = $("#data").next().find('.layui-table-total').html()
                $("#data").next().find('.layui-table-total').find('td[data-field="cusname"] div').text("小计");
                if (!$(".zongheji").html()){
                    $("#data").next().find('.layui-table-total').after("<div class='zongheji'>"+heji+"</div>");
                    $.ajax({
                        type : 'get',
                        url : "/stockoutss/listByCondition",
                        data:{cusid:$('#cusid').val(),mxwhid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),status:9,groupby:"invid,invname,cpgg,whid",orderBy:"order by invname,cpgg"},
                        async : false,
                        success : function(datas) {
                              var inum="",jian="",imoney="";
                              for (var i=0;i<datas.data.length;i++){
                                  var data = datas.data[i];
                                  formatData(data);
                                  if (data.inum) inum = Number(inum) + Number(data.inum);
                                  if (data.jian) jian = Number(jian) + Number(data.jian)
                                  if (data.imoney) imoney = Number(imoney) + Number(data.imoney)
                              }
                              $("#data").next().find('.zongheji').find('td[data-field="inum"] div').text(inum);
                              $("#data").next().find('.zongheji').find('td[data-field="jian"] div').text(jian);
                              $("#data").next().find('.zongheji').find('td[data-field="imoney"] div').text(imoney);
                        }
                    })
                }
            }
        }
    });

    //监听排序事件
    table.on('sort(data)', function(obj){ //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
        tableIns.reload({
            initSort: obj //记录初始排序，如果不设的话，将无法标记表头的排序状态。
            ,where: { //请求参数（注意：这里面的参数可任意定义，并非下面固定的格式）
                cusname:$('#cusname').val(),cusid:$('#cusid').val(),whid:$('#whid').val(),status:$('#status').val(),sminvname:$("#invid").val(),
                sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),inum:"00",
                orderBy: "order by " + obj.field + " " + obj.type//排序字段 + 排序方式
            }
            ,page:{curr:1}
        });
    });

    //监听行单击事件（双击事件为：rowDouble）
    table.on('row(data)', function(obj){
        //标注选中样式
        obj.tr.addClass('clickRow').siblings().removeClass('clickRow');
    });

    // form.on('select(whid)', function(data){
    //     var whid = data.value;
    //     var select = $("#invid");
    //     select.html("");
    //     if(whid){
    //         invdata = getInvname(whid);
    //         select.append("<option value=''>请选择</option>");
    //         $.each(invdata, function(id, d) {
    //             select.append("<option value ='" + d.id + "'>" + d.name + "</option>");
    //         });
    //     }
    //     renderForm()
    // });

    $("#whid").change(function(){
        var whid = $(this).val();
        var select = $("#invid");
        select.html("");
        if(whid){
            invdata = getInvname(whid);
            select.append("<option value=''>请选择</option>");
            $.each(invdata, function(id, d) {
                select.append("<option value ='" + d.id + "'>" + d.name + "</option>");
            });
        }
        renderForm()
    });

    form.on('select(inv)', function(data){
        // console.log(data.elem); //得到select原始DOM对象
        // console.log(data.value); //得到被选中的值
        // console.log(data.othis); //得到美化后的DOM对象
        var invname = data.value;
        var select = $("#smcpgg");
        select.html("");
        if(invname){
            // $.ajax({
            //     type : 'get',
            //     url : '/invs/listCpggByInvname/?invname=' + invname,
            //     async : false,
            //     success : function(data) {
            //         select.append("<option value=''>请选择</option>");
            //         $.each(data.data, function(id, d) {
            //             select.append("<option value ='" + d + "'>" + d + "</option>");
            //         });
            //
            //     }
            // });
        }
        renderForm();
    });
//监听工具条
    table.on('tool(data)', function(obj){
        var data = obj.data, event = obj.event, tr = obj.tr; //获得当前行 tr 的DOM对象;
        switch(event){
            case "madan":
                layer.open({
                    type: 2,
                    title: '码单查询',
                    shadeClose: true,
                    shade: 0.8,
                    area: ['90%', '90%'],
                    content: encodeURI('../scjiliang/searchMd.html?invname='+data.invname+'&cpgg='+data.cpgg),
                    end : function(){
                    }
                });
                break;
            case "kcmx":
                var tiaojian = "";
                if (ctype == "sm"){
                    tiaojian = "?cusname="+data.cusname+"&whid="+$("#whid").val()+
                        "&sminvname="+$("#invid").val()+"&smcpgg="+$("#smcpgg").val()+"&sdate="+$("#sdate").val()+
                        "&edate="+$("#edate").val()+"&ctype="+ctype
                } else{
                    tiaojian = "?cusid="+$("#cusid").val()+"&cusname="+"&whid="+$("#whid").val()+"&invname="+$("#invname").val()+
                        "&cpgg="+$("#cpgg").val()+"&sdate="+$("#sdate").val()+
                        "&edate="+$("#edate").val()+"&ctype="+ctype
                }
                window.parent.layui.index.openTabsPage(encodeURI('pages/currstock/ylkcLogList.html'+tiaojian), '库存明细账')
                break;
        }

    });

    //执行实例
    var uploadInst = upload.render({
        elem: '#importBt' //绑定元素
        ,url: '/currstocks/currImport' //上传接口
        ,accept: 'file'
        ,done: function(res){
                if (res.code == 1){
                    layer.msg(res.msg);
                }
               //上传完毕回调
               if(res.code == 0){
                    layer.msg("上传并导入成功");
                    example.ajax.reload();
                }
        }
        ,error: function(){
            //请求异常回调
            layer.msg("数据导入失败");
        }
    });
});

// function del(id){
// 	layer.confirm('确定要删除吗？', {
//         btn : [ '确定', '取消' ]
//     }, function() {
//     	$.ajax({
//             type : 'delete',
//             url : '/currstocks/'+id,
//             success : function(data) {
//                 $('#searchBt').trigger('click');
//                 layer.msg("删除成功");
//             }
//         });
//
//         layer.close(1);
//     });
// }

function tianjiaKh(){
    layer.open({
        type: 2,
        title: '添加客户',
        shadeClose: true,
        shade: 0.8,
        area: ['70%', '70%'],
        content: '../customer/customerList.html?searchCus=true',
        end : function(){
            var kehu = JSON.parse($("#kehu").val());
            $("#cusid").val(kehu.id);
            $("#ksname").val(kehu.cname);
        }
    });
}

$("#delCus").click(function(event){
    event.stopPropagation();
    $("#ksname").val("");
    $("#cusid").val("");
})

$("#searchBt").click(function(){
    var type = $("#type").val();
    if(type == 2){
        if (ctype == "sm"){
            tableIns.reload({url:"/stockoutss/layuiList",where: {cusname:$('#cusname').val(),cusid:$('#cusid').val(),mxwhid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),status:9,orderBy:"order by ksid desc,invname,cpgg"},page:{curr:1}})
        } else{
            tableIns.reload({url:"/stockoutss/layuiList",where: {cusname:$('#cusname').val(),cusid:$('#cusid').val(),whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),status:9,orderBy:"order by ksid desc,invname,cpgg"},page:{curr:1}})
        }
    }else if(type == 3){
        if (ctype == "sm"){
            tableIns.reload({url:"/stockoutss/layuiList",where: {cusid:$('#cusid').val(),mxwhid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),status:9,groupby:"invid,invname,cpgg,whid",orderBy:"order by invname,cpgg"},page:{curr:1}})
        }else{
            tableIns.reload({url:"/stockoutss/layuiList",where: {cusname:$('#cusname').val(),cusid:$('#cusid').val(),whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),status:9,groupby:"cusid,invid,invname,cpgg,whid",orderBy:"order by cusname desc,invname,cpgg"},page:{curr:1}})
        }
    }else if(type == 4){
        tableIns.reload({url:"/stockinss/layuiList",where: {whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),sinStatus:1,orderBy:"order by invname,cpgg"},page:{curr:1}})
    }else if(type == 5){
        tableIns.reload({url:"/stockinss/layuiList",where: {whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),sinStatus:1,groupby:"invid,invname,cpgg,whid",orderBy:"order by invname,cpgg"},page:{curr:1}})
    }else if(type == 6){
        tableIns.reload({url:"/currstocks/list2",where: {cusid:$('#cusid').val(),cusname:$('#cusname').val(),whid:$('#whid').val(),sminvname:$("#invid").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),inum:"00",groupby:"invid,invname,cpgg,whid",orderBy:"order by invname,cpgg"},page:{curr:1}})
    }else{
        tableIns.reload({url:"/currstocks/list2",where: {cusid:$('#cusid').val(),cusname:$('#cusname').val(),whid:$('#whid').val(),sminvname:$("#invid").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),inum:"00",orderBy:"order by invname,cpgg"},page:{curr:1}})
    }
});

//根据仓库获取品名
function getInvname(whid){
    var invdata = []
    if (whid) {
        if (whid == 10){
            invdata =  getinvGroupInvname("3");
        } else if(whid == 5){
            invdata =  getinvGroupInvname("13");
        } else if(whid == 6){
            invdata =  getinvGroupInvname("15");
        }
    }
    return invdata;
}

function rkmx(c){
        var invid = $(c).data("invid");
        var cpgg = $(c).data("cpgg");
        window.parent.layui.index.openTabsPage('pages/stockin/stockinMx.html?invid='+ invid +'&cpgg='+ escape(cpgg) +'&ctype=sm', '入库明细表')
};

function ckmx(c){
    var invid = $(c).data("invid")
    var cpgg = $(c).data("cpgg")
    window.parent.layui.index.openTabsPage('pages/stockout/stockoutMx.html?invid='+ invid +'&cpgg='+ escape(cpgg) +'&ctype=sm', '出库明细表')
};

$("#exportBt").click(function(){
    $("#token").val(localStorage.getItem("token"))
    var action = "";
    var type = $("#type").val();
    if(type == 2){
        action = "/stockoutss/export?orderBy=order by ddate desc";
    }else if(type == 3){
        action = "/stockoutss/export?groupby=invid,invname,cpgg,whid";
    }else if(type == 4){
        action = "/stockinss/export?orderBy=order by ddate desc";
    }else if(type == 5){
        action = "/stockinss/export?groupby=invid,invname,cpgg,whid";
    }else{
        action = "/currstocks/export?orderBy=order by ddate desc";
    }

    $("#form").attr("action", action);
    $("#form").attr("onsubmit", "return true");
    $("#form").submit();
    $("#form").attr("onsubmit", "return false");
});

$("#printBt").click(function(){
    var html = "";
    var title = "";
    var ulr = "";
    var data = {whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),inum:"00",orderBy:"order by ddate desc"};
    var type = $("#type").val();
    if(type == 2){
         title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司出库明细</h2>";
         url = "/stockoutss/listByCondition";
    }else if(type == 3){
         title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司出库汇总</h2>";
         url = "/stockoutss/listByCondition";
         data = {whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),groupby:"invid,invname,cpgg,whid"}
    }else if(type == 4){
         title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司入库明细</h2>";
         url = "/stockinss/listByCondition";
    }else if(type == 5){
         title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司出库汇总</h2>";
         url = "/stockinss/listByCondition";
         data = {whid:$('#whid').val(),sminvname:$("#invid").val(),sdate:$("#sdate").val(),edate:$("#edate").val(),invname:$("#invname").val(),cpgg:$("#cpgg").val(),smcpgg:$("#smcpgg").val(),groupby:"invid,invname,cpgg,whid"}
    }else{
        if (ctype == 'yl'){
            title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司原料库存</h2>";
            data.orderBy = "order by invcid";
        }else{
            title = "<h2 style='text-align: center'>山西金贵塑料制造有限公司库存</h2>";
        }
        url = "/currstocks/listByCondition";
    }

    html += title;
    var money = 0;
    if (ctype == 'yl'){
        html += "<table class='print-yltable'>" +
            "<tr><td style='border:none' colspan='2'></td><td style='border:none;' colspan='3'>日期：" +
            ""+new Date().getFullYear() + "-" +((new Date().getMonth()+1)<10?"0":"")+(new Date().getMonth()+1)+"-"+(new Date().getDate()<10?"0":"")+new Date().getDate()+"  "+new Date().getHours()+":"+(new Date().getMinutes()<10?"0":"")+new Date().getMinutes()+":"+new Date().getSeconds()+"</td></tr>"+
            "<tr><th style='border-left: 1px solid #000;'>仓库</th><th>品名</th><th>数量</th><th>单价</th><th>金额</th></tr>";
    } else{
        html += "<table class='print-table'>" +
            "<tr><th style='border-left: 1px solid #000;'>仓库</th><th>日期</th><th>品名</th><th>规格</th><th>单位</th><th>件</th><th>件重</th><th>数量</th><th>单价</th><th>金额</th></tr>";
    }

    $.ajax({
        type : 'get',
        url : url,
        data:data,
        async : false,
        success : function(datas) {
            var hangshu = datas.data.length;
            var yeshu = hangshu / 25;
            var dijiye = 1;
            var dijihang = 0;
            if (ctype == 'yl') {
                while (yeshu > 0) {
                    if (dijihang != 0)
                           html += "<tr style='height:50px;'><td style='border-right:none;border-bottom: none' colspan='5'></td></tr>" +
                               "<tr><td style='border:none' colspan='2'></td><td style='border:none' colspan='3'>日期：" +
                               ""+new Date().getFullYear() + "-" +((new Date().getMonth()+1)<10?"0":"")+(new Date().getMonth()+1)+"-"+(new Date().getDate()<10?"0":"")+new Date().getDate()+"  "+new Date().getHours()+":"+(new Date().getMinutes()<10?"0":"")+new Date().getMinutes()+":"+new Date().getSeconds()+"</td></tr>"+
                               "<tr><th style='border-left: 1px solid #000;'>仓库</th><th>品名</th><th>数量</th><th>单价</th><th>金额</th></tr>"
                    for (var i = 0; i < 25; i++) {
                        var curr = datas.data[dijihang]
                        if (curr) {
                            formatData(datas.data[dijihang]);
                            if (datas.data[i].inum) {

                                html += "<tr><td style='border-left: 1px solid #000;'>" + curr.whname + "</td><td>" + curr.invname + "</td><td>" + curr.inum + "</td><td>" + curr.iprice + "</td><td>" + curr.imoney + "</td>" +
                                    "</tr>";
                            }
                            dijihang++;
                        }
                    }
                    yeshu --;
                }
            }else {
                for (var i = 0; i < datas.data.length; i++) {
                    formatData(datas.data[i])
                    var bianhao = i + 1;
                    console.log("len:" + datas.data.length);
                    html += "<tr><td style='border-left: 1px solid #000;'>" + datas.data[i].whname + "</td><td>" + datas.data[i].ddate + "</td><td>" + datas.data[i].invname + "</td><td>" + datas.data[i].cpgg + "</td><td>" + datas.data[i].danwei + "</td><td>" + datas.data[i].jian + "</td><td>" + datas.data[i].jianzhong + "</td><td>" + datas.data[i].inum + "</td><td>" + datas.data[i].iprice + "</td><td>" + datas.data[i].imoney + "</td>" +
                        "</tr>";

                    money += Number(datas.data[i].imoney);


                }
            }
        }
    });

    html += "</table>";
    html = html.replace("null","").replace("null","").replace("null","").replace("null","").replace("undefined","").replace("undefined","");

    $("#test").print({
        //Use Global styles
        globalStyles : false,
        //Add link with attrbute media=print
        mediaPrint : false,
        //Print in a hidden iframe
        iframe : false,
        //Don't print this
        noPrintSelector : ".avoid-this",
        //Add this at top
        prepend : html,
        //Add this on bottom
        append : "",
        //Log to console when printing is done via a deffered callback
        deferred: $.Deferred().done(function() { console.log('Printing done', arguments); }),
        stylesheet:'../../css/fahuoprint.css'
    });
});

$("#kclog").click(function(){
   var tiaojian = "?cusid="+$("#cusid").val()+"&cusname="+$("#cusname").val()+"&whid="+$("#whid").val()+"&invname="+$("#invname").val()+
       "&sminvname="+$("#invid").val()+"&cpgg="+$("#cpgg").val()+"&smcpgg="+$("#smcpgg").val()+"&sdate="+$("#sdate").val()+
       "&edate="+$("#edate").val()+"&ctype="+ctype
   window.parent.layui.index.openTabsPage(encodeURI('pages/currstock/ylkcLogList.html'+tiaojian), '库存明细账')
})
</script>
