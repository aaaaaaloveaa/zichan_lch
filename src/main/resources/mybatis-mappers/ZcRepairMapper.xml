<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.itycu.server.dao.ZcRepairDao">

	<sql id="where">
		<where>
			<if test="params.id != null and params.id != ''">
				and t.id = #{params.id} 
			</if>
			<if test="params.applyUserId != null and params.applyUserId != ''">
				and t.apply_user_id = #{params.applyUserId} 
			</if>
			<if test="params.applyDeptId != null and params.applyDeptId != ''">
				and t.apply_dept_id = #{params.applyDeptId} 
			</if>
			<if test="params.zcIds != null and params.zcIds != ''">
				and t.zc_ids = #{params.zcIds} 
			</if>
			<if test="params.repairDes != null and params.repairDes != ''">
				and t.repair_des = #{params.repairDes} 
			</if>
			<if test="params.bz != null and params.bz != ''">
				and t.bz = #{params.bz} 
			</if>
			<if test="params.flowid != null and params.flowid != ''">
				and t.flowid = #{params.flowid} 
			</if>
			<if test="params.stepid != null and params.stepid != ''">
				and t.stepid = #{params.stepid} 
			</if>
			<if test="params.status != null and params.status != ''">
				and t.status = #{params.status} 
			</if>
			<if test="params.repairCategory != null and params.repairCategory != ''">
				and t.repair_category = #{params.repairCategory} 
			</if>
			<if test="params.del != null and params.del != ''">
				and t.del = #{params.del} 
			</if>
			<if test="params.createBy != null and params.createBy != ''">
				and t.create_by = #{params.createBy} 
			</if>
			<if test="params.updateBy != null and params.updateBy != ''">
				and t.update_by = #{params.updateBy} 
			</if>
			<if test="params.createTime != null and params.createTime != ''">
				and t.create_time = #{params.createTime} 
			</if>
			<if test="params.updateTime != null and params.updateTime != ''">
				and t.update_time = #{params.updateTime} 
			</if>
			<if test="params.sdate != null and params.sdate != '' and params.edate != null and params.edate != ''">
				and <![CDATA[ t.create_time >= #{params.sdate} and t.create_time < DATE_FORMAT(DATE_ADD(#{params.edate},INTERVAL 1 DAY),'%Y-%m-%d') ]]>
			</if>
			<if test="params.code != null and params.code != ''">
				and t.code = #{params.code}
			</if>
			<if test="params.deptCode != null and params.deptCode != ''">
				and t.deptCode = #{params.deptCode}
			</if>
		</where>
	</sql>

	<select id="getById" resultType="com.itycu.server.dto.ZcRepairDto">
		select t.*
		,t_creator.nickname as creator
		,a_user.nickname as nickname
		,a_dept.deptname as deptname
		,c_user.nickname as confirmNickname
		,c_dept.deptname as confirmDeptname
		from zc_repair t
		LEFT OUTER JOIN sys_user t_creator ON t.create_by=t_creator.id
		LEFT OUTER JOIN sys_user a_user ON t.apply_user_id=a_user.id
		LEFT OUTER JOIN t_dept a_dept ON t.apply_dept_id=a_dept.id
		LEFT OUTER JOIN sys_user c_user ON t.confirm_by=c_user.id
		LEFT OUTER JOIN t_dept c_dept ON t.confirm_dept=c_dept.id
		where t.id = #{id}
	</select>

	<select id="count" resultType="int">
		select count(1) from zc_repair t
		<include refid="where" />
	</select>

	<select id="list" resultType="com.itycu.server.dto.ZcRepairDto">
		select t.*
		,t_creator.nickname as creator
		,a_user.nickname as nickname
		,a_dept.deptname as deptname
		,c_user.nickname as confirmNickname
		,c_dept.deptname as confirmDeptname
		from zc_repair t
		LEFT OUTER JOIN sys_user t_creator ON t.create_by=t_creator.id
		LEFT OUTER JOIN sys_user a_user ON t.apply_user_id=a_user.id
		LEFT OUTER JOIN t_dept a_dept ON t.apply_dept_id=a_dept.id
		LEFT OUTER JOIN sys_user c_user ON t.confirm_by=c_user.id
		LEFT OUTER JOIN t_dept c_dept ON t.confirm_dept=c_dept.id
		<include refid="where" />
		${params.orderBy}
		limit #{offset}, #{limit}
	</select>

	<update id="update">
		update zc_repair t
		<set>
			<if test="applyUserId != null">
				apply_user_id = #{applyUserId}, 
			</if>
			<if test="applyDeptId != null">
				apply_dept_id = #{applyDeptId}, 
			</if>
			<if test="zcIds != null">
				zc_ids = #{zcIds}, 
			</if>
			<if test="repairDes != null">
				repair_des = #{repairDes}, 
			</if>
			<if test="bz != null">
				bz = #{bz}, 
			</if>
			<if test="flowid != null">
				flowid = #{flowid}, 
			</if>
			<if test="stepid != null">
				stepid = #{stepid}, 
			</if>
			<if test="status != null">
				status = #{status}, 
			</if>
			<if test="repairCategory != null">
				repair_category = #{repairCategory}, 
			</if>
			<if test="del != null">
				del = #{del}, 
			</if>
			<if test="createBy != null">
				create_by = #{createBy}, 
			</if>
			<if test="updateBy != null">
				update_by = #{updateBy}, 
			</if>
			<if test="createTime != null">
				create_time = #{createTime}, 
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime}, 
			</if>
			<if test="code != null">
				code = #{code},
			</if>
			<if test="deptCode != null">
				deptCode = #{deptCode},
			</if>
			<if test="confirmTime != null">
				confirm_time = #{confirmTime},
			</if>
			<if test="confirmBy != null">
				confirm_by = #{confirmBy},
			</if>
			<if test="confirmDept != null">
				confirm_dept = #{confirmDept},
			</if>
		</set>

		where t.id = #{id}
	</update>

	<!--更新报修的状态-->
	<update id="updateStatus">
		update zc_repair t
		<set>
			<if test="params.status != null">
				t.status = #{params.status},
			</if>
			<if test="params.stepid">
				t.stepid = #{params.stepid},
			</if>
			<if test="params.confirmTime != null">
				t.confirm_time = #{params.confirmTime},
			</if>
			<if test="params.confirmBy != null">
				t.confirm_by = #{params.confirmBy},
			</if>
			<if test="params.confirmDept != null">
				t.confirm_dept = #{params.confirmDept},
			</if>
		</set>
		where t.id = #{params.zcReId} and del = 0
	</update>

	<!--查询本年度该商行的报修数-->
	<select id="countByDeptThisYear" parameterType="string" resultType="int">
        SELECT count(1) FROM zc_repair t WHERE YEAR(t.create_time) = YEAR(now()) AND t.deptCode LIKE concat(#{deptcode},'%')
    </select>


	<select id="queryZcRepairById" resultType="int">
		select count(1) from zc_repair where
		apply_dept_id  = #{id} and status = 2
		and DATE_FORMAT( create_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' )
	</select>

	<select id="queryDeptZcRepairById" resultType="int">
		SELECT
			count( 1 )
		FROM
			t_dept AS a
			LEFT JOIN zc_repair AS b ON a.id = b.apply_dept_id
		where a.jx = (select a.jx  from t_dept as c where c.id =#{id})
			and b.apply_dept_id is not null
			<if test="id!=null and id!=''">
				and a.id = #{id}
			</if>

			and DATE_FORMAT( b.create_time, '%Y%m' ) = DATE_FORMAT( CURDATE( ) , '%Y%m' )
	</select>
</mapper>
