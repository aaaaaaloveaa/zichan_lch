<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black">
	<link rel="stylesheet" type="text/css" media="screen" href="../../css/bootstrap.min.css">
	<link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all" />
	<link rel="stylesheet" href="../../css/font-awesome/css/font-awesome.css" media="all" />
	<link rel="stylesheet" href="../../css/mui.min.css">
</head>
<body>
<style>
	.layui-form-label{
		width:30%;
	}
	.layui-input-inline{
		width:70%;
	}
	.addbtn{
		display: block;
		margin: 0 auto;
		margin-top:15px;
		width:150px;
		height:50px;
		border-style:dashed;
		color:royalblue 
	}
	.demoTable{
		position: fixed;
		left: 0%;
		bottom: 0px;
		width:100%;
		height:60px
	}
	.demoTable-btn{
		width:50%;
		height:60px;
		float: left;
	}	
</style>
<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
	<input id="shuzhi" style="display: none;"/>
	
	<form class="layui-form layui-form-pane form-horizontal" onsubmit="return false" id="form">
		<input id="id" name="id" style="display:none">
		<div class='layui-form-item'>
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>计划编码</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='计划编码' type='text' name='ccode' id='ccode' >-->
				<!--</div>-->
			<!--</div>-->
			<div class='layui-inline'>
				<label class='layui-form-label'>订单日期</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='订单日期' type='text' name='ddate' id='ddate' >
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label '>业务类型</label>
				<div class='layui-input-inline'>
					<select class="layui-input" name="busstype" id="busstype"></select>
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>供应商</label>
				<div class='layui-input-inline'>
					<select class="layui-input" name="ksid" id="ksid"></select>
				</div>
			</div>


			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>单据来源</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='单据来源' type='text' name='csource' id='csource' >-->
				<!--</div>-->
			<!--</div>-->
			<div class='layui-inline'>
				<label class='layui-form-label'>数量</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='数量' type='text' name='inum' id='inum' >
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>金额</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='金额' type='text' name='imoney' id='imoney' >
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>税率</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='税率' type='text' name='taxrate' id='taxrate' >
				</div>
			</div>
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>对应业务单号</label>-->
				<!--<div class='layui-input-inline'>-->
					<input class='layui-input' placeholder='对应业务单号' type='hidden' name='bussid' id='bussid' >
				<!--</div>-->
			<!--</div>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>价格类型</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='价格类型' type='text' name='jglx' id='jglx' >-->
				<!--</div>-->
			<!--</div>-->


		<!--<div class='layui-form-item'>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>仓库</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--&lt;!&ndash;<input class='layui-input' placeholder='仓库' type='text' name='whid' id='whid' >&ndash;&gt;-->
					<!--<select class='layui-input input-sm' type='text' name='whid' id='whid' ></select>-->
				<!--</div>-->
			<!--</div>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>部门</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='部门' type='text' name='deptid' id='deptid' >-->
				<!--</div>-->
			<!--</div>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>业务员</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='业务员' type='text' name='userid' id='userid' >-->
				<!--</div>-->
			<!--</div>-->
		<!--</div>-->
			<div class='layui-inline'>
				<label class='layui-form-label'>税额</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='税额' type='text' name='tax' id='tax' >
				</div>
			</div>

			<div class='layui-inline'>
				<label class='layui-form-label'>价税合计</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='价税合计' type='text' name='itotal' id='itotal' >
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>付款方式</label>
				<div class='layui-input-inline'>
					<select class="layui-input" name="fkfs" id="fkfs"></select>
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>运费单价</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='运费单价' type='text' name='yfdj' id='yfdj' >
				</div>
			</div>

			<div class='layui-inline'>
				<label class='layui-form-label'>运费金额</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='运费金额' type='text' name='yfje' id='yfje' >
				</div>
			</div>
			<div class='layui-inline'>
				<label class='layui-form-label'>备注</label>
				<div class='layui-input-inline'>
					<input class='layui-input' placeholder='备注' type='text' name='memo' id='memo' >
				</div>
			</div>
			<input class='layui-input' placeholder='运费付款单号' type='hidden' name='yffkid' id='yffkid' >

		</div>


		<!--<div class='layui-inline'>-->
			<!--<label class='layui-form-label'>到货数量</label>-->
			<!--<div class='layui-input-inline'>-->
				<!--<input class='layui-input' placeholder='到货数量' type='text' name='dhsl' id='dhsl' >-->
			<!--</div>-->
		<!--</div>-->
		<!--<div class='layui-form-item'>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>到货金额</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='到货金额' type='text' name='dhje' id='dhje' >-->
				<!--</div>-->
			<!--</div>-->


			<!-- <div class='layui-inline'>
                 <label class='layui-form-label'>入库数量</label>
                 <div class='layui-input-inline'>
                     <input class='layui-input' placeholder='入库数量' type='text' name='rksl' id='rksl' >
                 </div>
             </div>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>已开发票</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='已开发票' type='text' name='ykfp' id='ykfp' >-->
				<!--</div>-->
			<!--</div>-->
			<!--<div class='layui-inline'>-->
				<!--<label class='layui-form-label'>已付金额</label>-->
				<!--<div class='layui-input-inline'>-->
					<!--<input class='layui-input' placeholder='已付金额' type='text' name='yfkje' id='yfkje' >-->
				<!--</div>-->
			<!--</div>-->
		<!--</div>-->
	</form>
</div>

<div id="data"></div>

<div class="mui-input-row" style="height:90px;">
	<button class="addbtn" onclick="tianjia()"><span class="mui-icon mui-icon-plusempty"></span><span>添加存货</span></button>
</div>
<div style="height:60px"></div>
<div class="demoTable">
		<button class="mui-btn mui-btn-grey demoTable-btn"  onclick="add(0)">
				<font color="black">暂存</font>
		</button>
		<button class="mui-btn mui-btn-yellow demoTable-btn"  onclick="add(1)">
				保存
		</button>
</div>

	<script src="../../js/mui.min.js"></script>
    <script type="text/javascript" src="../../js/properties.js" ></script>
    <script type="text/javascript" src="../../js/jquery.min.js"></script>
<script type="text/javascript" src="../../js/jq.js"></script>
<script type="text/javascript" src="../../js/plugin/bootstrapvalidator/bootstrapValidator.min.js"></script>
<script type="text/javascript" src="../../js/common.js"></script>
<script type="text/javascript" src="../../layuiadmin/layui/layui.js"></script>
<script type="text/javascript" src="../../js/dict.js"></script>
<script type="text/javascript" src="../../js/vendor.js"></script>
<script type="text/javascript">
    var self = null;

    showDictNameSelect("busstype", "cgddtype",false);
    showDictNameSelect("fkfs", "fktype",false);
    showVenSelect("ksid", "vendor", false);
    //    showCusSelect("ksid", "customer", true);


mui.plusReady(function() {
	self = plus.webview.currentWebview();
	
	mui.init({								
		beforeback: function() {	        
				self.close();
		}
	});	
	
    layui.use(['layer','form','laydate','table'], function(){
        var layer = layui.layer;
        var form = layui.form;

        var laydate = layui.laydate;
        laydate.render({
            elem: '#ddate'
			,value: new Date()
        });
        
        self = plus.webview.currentWebview();
		
		var id = self.jhid;

        initData(id);

        
        function initData(id){
//            console.log(id)
            if(id){
                $.ajax({
                    type : 'get',
                    url : server_url+'/cgJihuas/'+id,
                    async : false,
                    success : function(data) {
                        $('#id').val(data.id);
                        $('#ddate').val(data.ddate);
                        $('#busstype').val(data.busstype);
                        $('#ksid').val(data.ksid);
                        $('#inum').val(data.inum);
                        $('#taxrate').val(data.taxrate);
                        $('#tax').val(data.tax);
                        $('#imoney').val(data.imoney);
                        $('#itotal').val(data.itotal);
                        $('#yfdj').val(data.yfdj);
                        $('#yfje').val(data.yfje);
                        $('#memo').val(data.memo.replace("申请","订购"));

                        renderForm();       //重新渲染表单
                    }
                });

                $.ajax({
                    type : 'get',
                    url : server_url+"/cgJihuass/listBypid?pid="+id,
                    async : false,
                    success : function(oldData) {
					    var html = "";
						for(var i=0;i<oldData.data.length;i++){
							    var data = oldData.data[i];
								if(data.invname == null){
							    	data.invname = "";
							    }
							    if(data.cpgg == null){
							    	data.cpgg = "";
							    }
							    if(data.danwei == null){
							    	data.danwei = "";
							    }
							    if(data.inum == null){
							    	data.inum = "";
							    }
							    if(data.iprice == null){
							    	data.iprice = "";
							    }
							    if(data.imoney == null){
							    	data.imoney = "";
							    }
							    if(data.memo == null){
							    	data.memo = "";
							    }
								var num = i+1;
			                    html += "<div data-index='"+i+"'>"+
										"<div class='mui-input-row'>"+
												"<label style='color:#9e9e9e'>采购明细("+num+")</label>"+	
												"<label class='delbtn' onclick='delinv(this)' style='float:right;width:15%;color:royalblue'>删除</label>"+
										"</div>"+
										"<form class='mui-input-group'>"+
											"<div class='mui-input-row' style='display: none;'>"+
												"<label >存货ID</label>"+
												"<input placeholder='存货ID' class='invid'  type='text' data-field='invid' value='"+data.invid+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >存货</label>"+
												"<input placeholder='存货' type='text' data-field='invname' readonly value='"+data.invname+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >型号</label>"+
												"<input placeholder='型号' type='text' data-field='cpgg' value='"+data.cpgg+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >单位</label>"+
												"<input placeholder='单位' type='text' data-field='danwei' value='"+data.danwei+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >数量</label>"+
												"<input placeholder='数量' type='text' data-field='inum' onblur='suan(this)' value='"+data.inum+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >单价</label>"+
												"<input placeholder='单价' type='text' data-field='iprice' onblur='suan(this)' value='"+data.iprice+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >金额</label>"+
												"<input placeholder='金额' type='text' data-field='imoney' readonly value='"+data.imoney+"'>"+
											"</div>"+
											"<div class='mui-input-row'>"+
												"<label >备注</label>"+
												"<input placeholder='备注' type='text' data-field='memo' value='"+data.memo+"'>"+
											"</div>"+
										"</form>"+
										"<div class='mui-input-row'  style='color:#9e9e9e;padding-left:5px'>如需采购多种产品，请点击\"添加存货\"</div>"+
									"</div>"
						}
						$("#data").html(html)
                    }
                });
            }
        }

    });
 });	

    //监听税率,数量金额改变调用此函数更新税额和价税合计



    $("#taxrate").blur(function () {
        var value = parseFloat(this.value);
        var imoney = parseFloat($("#imoney").val());
        var tax = value*imoney;
        var tax1 = tax.toFixed(2);
        var itotal = imoney+tax;
        var itotal1 = itotal.toFixed(2);
//        console.log(typeof itotal);
        $("#tax").val(tax1);
        $("#itotal").val(itotal1);
    });

    $("#yfdj").blur(function () {
        var value = parseFloat(this.value);
        var inum = parseFloat($("#inum").val());
        var iyfje = inum * value;
        var iyfje1 = iyfje.toFixed(2);
        $("#yfje").val(iyfje1);
    });

    function add(iscommit) {
        var formdata = $("#form").serializeObject();
		
		var data = getData()
        if(!data || data.length == 0){
            layer.msg("请添加明细");
            return;
        }

        for (var i=0;i<data.length;i++){
            if(!data[i])
                continue;

            if(!matchNum(data[i].inum)){
                layer.msg("请输入正确的数量");
                return;
            }else{
                if(data[i].inum<=0){
                    layer.msg("数量不能小于等于0");
                    return
                }
            }
        }
        formdata.cgDingdansList = data;
		formdata.ctype = "2";
        $.ajax({
            type : 'post',
            url : server_url+'/cgDingdans',
            contentType: "application/json; charset=utf-8",
            data : JSON.stringify(formdata),
            success : function(data) {
				mui.plusReady(function() {						 
							var clist = plus.webview.getWebviewById("caigou/ylddlist.html");
							mui.fire(clist, 'refresh'); 	
							layer.msg("保存成功", {shift: -1, time: 1000}, function(){
									self.close();  
							});
				})
            }
        });
    }

    function tianjia(){
    	mui.openWindow({
    					url: "../webview_main.html",
    					id: "invwebview_main.html",
    					preload: true,
    					show: {
    						aniShow: 'pop-in'
    					},
    					styles: {
    						popGesture: 'hide',
    						titleNView: {
    							autoBackButton: true,
    							titleText:"添加存货",
    						}
    					},
    					waiting: {
    						autoShow: false
    					},	
    					extras: { //新窗口的额外扩展参数,可用来处理页面间传值
    						url:"inv/searchInvList.html"
    					}
    				});
    }
    
    // 添加自定义事件监听
    window.addEventListener('loadInv',function(event){
      //获得事件参数
        var invs= event.detail.invs;
        var oldData = getData();
      					 				
      	if(!oldData){
      	    oldData = [];
      	}
    
      	var newData = invs
    
      	for(var i=0;i<newData.length;i++){
      	    if(i==0){
      	//              		console.log("newdata"+newData[i].invname);
      	        $("#memo").val($("#memo").val() + "申请" +newData[i].invname + "等");
      	    }
      	    var ishas = false;
      	//                  for(var a=0;a<oldData.length;a++){
      	//                      if(oldData[a].invid == newData[i].id){
      	//                          ishas = true;
      	//                      }
      	//                  }
      	
      	    if(!ishas){
      	        newData[i].invid = newData[i].id;
      	        newData[i].cpgg = newData[i].invstd;
      	        newData[i].inum = 0;
      	        newData[i].imoney = 0;
      	        oldData.push(newData[i]);
      	    }
      	}
      	
      	loadData(oldData)
    });
    
    function getData(){
		var data  = [];
		$("#data").children().each(function(){		
			data.push({invname:$(this).find("input[data-field='invname']").val(),
			           invid:$(this).find("input[data-field='invid']").val(),
					   cpgg:$(this).find("input[data-field='cpgg']").val(),
					   danwei:$(this).find("input[data-field='danwei']").val(),
					   inum:$(this).find("input[data-field='inum']").val(),
					   iprice:$(this).find("input[data-field='iprice']").val(),
					   imoney:$(this).find("input[data-field='imoney']").val(),
					   memo:$(this).find("input[data-field='memo']").val()
					 })
		})

		return data;
	}
    
    function loadData(oldData){
		var html = "";
		liebiao(oldData)
		for(var i=0;i<oldData.length;i++){
			    var data = oldData[i];
			    if(data.danwei == undefined){
			    	data.danwei = "";
			    }
				var num = i+1;
			    html += "<div data-index='"+i+"'>"+
							"<div class='mui-input-row'>"+
									"<label style='color:#9e9e9e'>采购明细("+num+")</label>"+	
									"<label class='delbtn' onclick='delinv(this)' style='float:right;width:15%;color:royalblue'>删除</label>"+
							"</div>"+
							"<form class='mui-input-group'>"+
								"<div class='mui-input-row' style='display: none;'>"+
									"<label >存货ID</label>"+
									"<input placeholder='存货ID' class='invid'  type='text' data-field='invid' value='"+data.invid+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >存货</label>"+
									"<input placeholder='存货' type='text' data-field='invname' readonly value='"+data.invname+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >型号</label>"+
									"<input placeholder='型号' type='text' data-field='cpgg' value='"+data.cpgg+"'>"+
								"</div>"+
							    "<div class='mui-input-row'>"+
									"<label >单位</label>"+
									"<input placeholder='单位' type='text' data-field='danwei' value='"+data.danwei+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >数量</label>"+
									"<input placeholder='数量' type='text' data-field='inum' onblur='suan(this)' value='"+data.inum+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >单价</label>"+
									"<input placeholder='单价' type='text' data-field='iprice' onblur='suan(this)' value='"+data.iprice+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >金额</label>"+
									"<input placeholder='金额' type='text' data-field='imoney' readonly value='"+data.imoney+"'>"+
								"</div>"+
								"<div class='mui-input-row'>"+
									"<label >备注</label>"+
									"<input placeholder='备注' type='text' data-field='memo' value='"+data.memo+"'>"+
								"</div>"+
							"</form>"+
							"<div class='mui-input-row'  style='color:#9e9e9e;padding-left:5px'>如需采购多种产品，请点击\"添加存货\"</div>"+
						"</div>"
		}

		$("#data").html(html)
	}
    
    function suan(n){
		var inum = $(n).parents("form").find("input[data-field='inum']").val();
		var iprice = $(n).parents("form").find("input[data-field='iprice']").val();
		var money = inum*iprice
		$(n).parents("form").find("input[data-field='imoney']").val(money.toFixed(2))
		
		var data = getData();
		var num = 0;
		var imoney = 0;
		for (var i=0;i<data.length;i++){
		    if(!data[i])
		        continue;
				    
			num = Number(num) + Number(data[i].inum)
			imoney = Number(imoney) + Number(data[i].imoney)
		}
		$("#inum").val(num);
		$("#imoney").val(imoney.toFixed(2));
	}
	
	function delinv(inv){
		mui.confirm('确认删除该条记录？', 'Hello MUI', btnArray, function(e) {
				if(e.index==1){
					$(inv).parent().parent().remove()
				}                                     
		});
		var btnArray = ['确认', '取消'];		
	}


	//格式化列表值
	function liebiao(data){
		 for(var i=0;i<data.length;i++){
			  for(l in data[i]){
				  if(!data[i][l]){
					  data[i][l] = "";
				  }
			  }
		 }
	}
    
</script>
</body>
</html>
